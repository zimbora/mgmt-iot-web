<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../../partials/head.ejs') %>
  
  <style>
    td {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 150px;
    }

    .small-btn {
      padding: 0rem 0.5rem;
      height: 1.5rem;
    }

    .small-icon {
      font-size: 0.75rem;
    }
    
    .switch {
      position: relative;
      display: inline-block;
      width: 34px; /* Reduced width */
      height: 20px; /* Reduced height */
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 10px; /* Rounded corners */
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 14px; /* Reduced size of the toggle */
      width: 14px; /* Reduced size of the toggle */
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%; /* Rounded toggle */
    }

    input:checked + .slider {
      background-color: #2196F3;
    }

    input:focus + .slider {
      box-shadow: 0 0 1px #2196F3;
    }

    input:checked + .slider:before {
      -webkit-transform: translateX(14px);
      -ms-transform: translateX(14px);
      transform: translateX(14px);
    }
  </style>
</head>
<body>

  <%- include('../../partials/scripts.ejs') %>
  <%- include('../../partials/project/navbar.ejs') %>

  <%- include('../../partials/modal/confirmation.ejs') %>
  <%- include('../../partials/modal/error.ejs') %>
  <%- include('../../partials/modal/success.ejs') %>

  <link href="./assets/css/jquery.dataTables.min.css" rel="stylesheet">
  <script src="./assets/js/jquery.dataTables.min.js"></script>
  <script src="./assets/js/fontawesome.js"></script>

  <div class="container-fluid">
    <div class="row flex-nowrap">
      <%- include('../../partials/device/sidebar.ejs') %>
      <!--<div id="loading"></div>-->
      <div class="col py-3">
        <div class="content-header">
          <div class="d-flex justify-content-between align-items-center">
            <h3><%= project?.name %> - Edit device: <%= device?.name || device?.uid %></h3>
          </div>
        </div>

        <!-- MQTT Topics Section -->
        <div class="row mt-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5 class="card-title">MQTT Topics</h5>
              </div>
              <div id="mqttTopicsContainer"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Edit Topic Modal -->
  <div class="modal fade" id="editTopicModal" tabindex="-1" aria-labelledby="editTopicModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editTopicModalLabel">Edit Topic</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="topicForm">
            <input type="hidden" id="entryId" name="entryId">
            
            <!-- Topic Path -->
            <div class="mb-3">
              <label for="topicPath" class="form-label">Topic Path</label>
              <input type="text" class="form-control" id="topicPath" name="topicPath" placeholder="sensors/temperature" required>
              <div class="form-text">Enter the MQTT topic path (e.g., sensors/temperature, status/online)</div>
            </div>

            <!-- Topic Title -->
            <div class="mb-3">
              <label for="topicTitle" class="form-label">Title</label>
              <input type="text" class="form-control" id="topicTitle" name="topicTitle" placeholder="Enter topic title" required>
            </div>

            <!-- Data Type -->
            <div class="mb-3">
              <label for="type" class="form-label">Data Type</label>
              <select class="form-select" id="type" name="type" required>
                <option value="string">String</option>
                <option value="integer">Integer</option>
                <option value="float">Float</option>
                <option value="boolean">Boolean</option>
                <option value="json">JSON</option>
              </select>
            </div>

            <!-- Read/Write Properties -->
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="readable" name="readable">
                  <label class="form-check-label" for="readable">Readable</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="writable" name="writable">
                  <label class="form-check-label" for="writable">Writable</label>
                </div>
              </div>
            </div>
            
            <!-- Reading Interval -->
            <div class="mb-3">
              <label for="readInterval" class="form-label">Reading Interval (seconds)</label>
              <select class="form-select" id="readInterval" name="readInterval">
                <option value="0">No automatic reading</option>
                <option value="5">5 Seconds</option>
                <option value="10">10 Seconds</option>
                <option value="30">30 Seconds</option>
                <option value="60">1 Minute</option>
                <option value="300">5 Minutes</option>
                <option value="900">15 Minutes</option>
                <option value="1800">30 Minutes</option>
                <option value="3600">1 Hour</option>
                <option value="14400">4 Hours</option>
                <option value="21600">6 Hours</option>
                <option value="43200">12 Hours</option>
                <option value="86400">24 Hours</option>
              </select>
            </div>

            <!-- Default Data -->
            <div class="mb-3">
              <label for="defaultData" class="form-label">Default Data</label>
              <input type="text" class="form-control" id="defaultData" name="defaultData" placeholder="Enter default data">
              <div class="form-text">Enter the default value for this topic</div>
            </div>

            <!-- Local Data -->
            <div id="localDataDiv" class="mb-3">
              <label for="localData" class="form-label">Local Data</label>
              <input type="text" class="form-control" id="localData" name="localData" placeholder="Enter local data">
              <div class="form-text">Enter the local value for this topic</div>
            </div>

            <!-- Synch -->
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="synch" name="synch">
                  <label class="form-check-label" for="synch" title="Synch local data with device">Synch</label>
                </div>
              </div>
            </div>

          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveTopic()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="./app.mjs"></script>
  
  <script>
    let device = <%- JSON.stringify(device) %>;
    var project = device.project;
    var uid = device.uid;
    var deviceId = device.id;
    var projectId = device.project_id;
    var deviceTopics = [];

    $(document).ready(function () {
      // Validate that we have the required IDs
      if (!deviceId || !projectId) {
        $('#loading').html('<div class="alert alert-danger">Error: Missing device or project information.</div>');
        return;
      }
      
      loadMqttTopics();
    });

    function loadMqttTopics() {
      const contentContainer = $('#mqttTopicsContainer');
      contentContainer.empty();

      contentContainer.html(`
          <div class="mt-3 p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6>MQTT Topics for device</h6>
              <button class="btn btn-primary small-btn" onclick="newTopic()">
                <i class="fas fa-plus small-icon"></i> Add Topic
              </button>
            </div>
            <div id="loading-topics" class="text-center py-3">
              <div class="spinner-border spinner-border-sm" role="status"></div>
              <span>Loading topics...</span>
            </div>
            <div class="table-responsive">
              <table id="topics-table" class="display table" style="width: 100%;">
                <thead>
                  <tr>
                    <th style="width: 20px;">Edit</th>
                    <th style="width: 40px;">Path</th>
                    <th style="width: 80px;">Name</th>
                    <th style="width: 40px;">Template</th>
                    <th style="width: 40px;" title="default data" >default</th>
                    <th style="width: 40px;" title="local data" >local</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div>
        `);

      api.device.getMqttTopics(deviceId, (err, topics) => {
        $('#loading-topics').hide();
        if (err) {
          console.error('Error loading MQTT topics:', err);
          $('#loading').html('<div class="alert alert-danger">Error loading MQTT topics: ' + err + '</div>');
          return;
        }

        if (!topics || topics.length === 0) {
          $('#loading').html('<div class="alert alert-info">No MQTT topics found.</div>');
          return;
        }

        deviceTopics = topics;
        const loadingEl = $(`#loading-topics`);
        const tableEl = $(`#topics-table`);
        
        loadingEl.hide();

        // Initialize DataTable
        const table = tableEl.DataTable({
          data: topics,
          columns: [
            {
              data: null,
              render: function(data, type, row) {
                const entryId = row.id;
                const isInSynch = row?.synch ? true : false;
                const showSynch = row?.synch ? '' : 'd-none';

                const isSynched = row?.synched ? true : false;
                const statusClass = isSynched ? 'bg-success' : 'bg-danger';
                const statusTitle = isSynched ? 'Synched with device' : 'Not synched';
                const statusText = isSynched ? 'Synched' : 'Not synched';

                return `
                  <div class="d-flex align-items-center">
                    <button class="btn btn-danger small-btn me-1" 
                      data-topic='${JSON.stringify(data)}' 
                      onclick="deleteTopic('${entryId}', this)">
                      <span class="icon small-icon">&times;</span>
                    </button>
                    <button class="btn btn-primary small-btn" 
                      data-topic='${JSON.stringify(data)}' 
                      onclick="editTopic('${entryId}', this)">
                      <i class="fas fa-pencil-alt small-icon"></i>
                    </button>
                    <span class="badge rounded-pill ${statusClass} me-2" title="${statusTitle}">${statusText}</span>
                    <span class="badge rounded-pill bg-info me-2 ${showSynch}" title="synching">synching</span>
                  </div>
                    `;
              }
            },
            {
              data: null,
              render: function(data, type, row) {
                // Safely access row.description.attributes.title
                if(row.topic)
                  return row.topic;
                else
                  return ``;
              }
            },
            {
              data: null,
              render: function(data, type, row) {
                // Safely access row.description.attributes.title
                return row.description?.attributes?.title || 'No Title';
              }
            },
            {
              data: null,
              render: function(data, type, row) {
                // Render template tag as green badge if it exists
                if (row.template_tag) {
                  return `<span class="badge bg-success">${row.template_tag}</span>`;
                } else {
                  return '';
                }
              }
            },
            {
              data: null,
              render: function (data, type, row) {
                const val = row?.defaultData?.value;

                // For sort/filter, return plain text (not HTML)
                if (type !== 'display') {
                  if (val == null) return '';
                  return (val !== null && typeof val === 'object') ? JSON.stringify(val) : String(val);
                }

                if (val == null) return '';

                const isObject = (v) => v !== null && typeof v === 'object';
                const text = isObject(val) ? JSON.stringify(val) : String(val);

                const escapeAttr = (s) =>
                  String(s)
                    .replace(/&/g, '&amp;')
                    .replace(/"/g, '&quot;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');

                const escaped = escapeAttr(text);

                // readonly => non-editable but selectable; use disabled if you prefer non-focusable
                return `<input type="text" class="form-control form-control-sm" style="width:100%;" value="${escaped}" readonly />`;
              },
            },
            {
              data: null,
              render: function (data, type, row) {
                const val = row?.localData?.value;
                
                // For sort/filter, return plain text (not HTML)
                if (type !== 'display') {
                  if (val == null) return '';
                  return (val !== null && typeof val === 'object') ? JSON.stringify(val) : String(val);
                }

                if (val == null) return '';

                const isObject = (v) => v !== null && typeof v === 'object';
                const text = isObject(val) ? JSON.stringify(val) : String(val);

                const escapeAttr = (s) =>
                  String(s)
                    .replace(/&/g, '&amp;')
                    .replace(/"/g, '&quot;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');

                const escaped = escapeAttr(text);

                // readonly => non-editable but selectable; use disabled if you prefer non-focusable
                return `<input type="text" class="form-control form-control-sm" style="width:100%;" value="${escaped}" readonly />`;
              },
            },
          ],
          pageLength: 10,
          searching: true,
          ordering: true,
          order: [], // Disable initial automatic ordering
        });

        tableEl.show();
      });
    }

    function deleteTopic(entryId, element) {
      const topicData = JSON.parse(element.getAttribute('data-topic'));
      
      if(topicData?.id !== undefined){
        api.device.mqtt.deleteTopic(deviceId, entryId,(err,res)=>{
          if(!err){
            loadMqttTopics();
          }else{
            console.log(err)
            $('#error').text('Error deleting MQTT topic');
            $('#suggestion').text(typeof err === 'string' ? err : 'An unexpected error occurred');
            $('#modalError').modal('show');
            return;
          }
        })
      }
    }

    function newTopic() {
      // Clear form
      document.getElementById('topicForm').reset();
      document.getElementById('entryId').value = '';
      document.getElementById('defaultData').value = '{"value":""}';
      
      // Set defaults
      document.getElementById('readable').checked = true;
      document.getElementById('writable').checked = false;
      document.getElementById('synch').checked = false;
      document.getElementById('readInterval').value = '0';
      
      // Update modal title
      document.getElementById('editTopicModalLabel').textContent = 'Add New Topic';
      
      let el = document.getElementById('defaultData');
      if (el) el.readOnly = false;

      el = document.getElementById('localDataDiv');
      if (el) el.style.display = 'none';

      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('editTopicModal'));
      modal.show();
    }

    function editTopic(topicId) {
      const topic = deviceTopics.find(t => t.id == topicId);
      if (!topic) {
        alert('Topic not found');
        return;
      }

      // Populate form
      document.getElementById('entryId').value = topic.id;
      document.getElementById('topicPath').value = topic.topic || '';
      document.getElementById('topicTitle').value = topic.description?.attributes?.title || '';
      document.getElementById('type').value = topic.description?.attributes?.type || 'string';
      document.getElementById('readable').checked = topic.description?.attributes?.readable || false;
      document.getElementById('writable').checked = topic.description?.attributes?.writable || false;
      document.getElementById('readInterval').value = topic.readInterval || 0;
      document.getElementById('synch').checked = topic.synch || false;
      
      // Handle default data
      if (topic.defaultData?.value !== undefined) {
        document.getElementById('defaultData').value = 
          typeof topic.defaultData.value === 'object' ? 
          JSON.stringify(topic.defaultData.value) : 
          topic.defaultData.value;
      } else {
        document.getElementById('defaultData').value = '';
      }

      // Handle remote data
      if (topic.localData?.value !== undefined) {
        document.getElementById('localData').value = 
          typeof topic.localData.value === 'object' ? 
          JSON.stringify(topic.localData.value) : 
          topic.localData.value;
      } else {
        document.getElementById('localData').value = '';
      }

      let el = document.getElementById('defaultData');
      if (el) el.readOnly = true;

      el = document.getElementById('localDataDiv');
      if (el) el.style.display = '';

      // Update modal title
      document.getElementById('editTopicModalLabel').textContent = 'Edit Topic';
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('editTopicModal'));
      modal.show();
    }

    function saveTopic() {
      const entryId = document.getElementById('entryId').value;
      const topicPath = document.getElementById('topicPath').value.trim();
      const topicTitle = document.getElementById('topicTitle').value.trim();
      const type = document.getElementById('type').value;
      const readable = document.getElementById('readable').checked;
      const writable = document.getElementById('writable').checked;
      const synch = document.getElementById('synch').checked;
      const readInterval = parseInt(document.getElementById('readInterval').value);
      const defaultDataValue = document.getElementById('defaultData').value.trim();
      const localDataValue = document.getElementById('localData').value.trim();

      // Validation
      if (!topicPath || !topicTitle) {
        alert('Topic path and title are required');
        return;
      }

      // Parse default data
      let defaultData = null;
      if (!document.getElementById('defaultData').readOnly && defaultDataValue) {
        try {
          if (type === 'json') {
            defaultData = { value: JSON.parse(defaultDataValue) };
          } else if (type === 'boolean') {
            defaultData = { value: defaultDataValue.toLowerCase() === 'true' };
          } else if (type === 'integer') {
            defaultData = { value: parseInt(defaultDataValue) };
          } else if (type === 'float') {
            defaultData = { value: parseFloat(defaultDataValue) };
          } else {
            defaultData = { value: defaultDataValue };
          }
        } catch (e) {
          alert('Invalid default data format');
          return;
        }
      }

      // Parse local data
      let localData = null;
      if (!document.getElementById('localData').readOnly && localDataValue) {
        try {
          if (type === 'json') {
            localData = { value: JSON.parse(localDataValue) };
          } else if (type === 'boolean') {
            localData = { value: localDataValue.toLowerCase() === 'true' };
          } else if (type === 'integer') {
            localData = { value: parseInt(localDataValue) };
          } else if (type === 'float') {
            localData = { value: parseFloat(localDataValue) };
          } else {
            localData = { value: localDataValue };
          }
        } catch (e) {
          alert('Invalid remote data format');
          return;
        }
      }

      const topicData = {
        topic: topicPath,
        description: {
          attributes: {
            type: type,
            title: topicTitle,
            readable: readable,
            writable: writable,
          }
        },
        readInterval: readInterval,
        synch: synch,
      };

      if(defaultData)
        topicData['defaultData'] = defaultData;

      if(localData)
        topicData['localData'] = localData;

      if (entryId) {
        // Update existing topic
        api.device.mqtt.updateTopic(deviceId, entryId, topicData, (err, res) => {
          if (!err) {
            loadMqttTopics();
            // Close the modal
            const modalElement = document.getElementById('editTopicModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            modal.hide();
          } else {
            console.log(err);
            $('#error').text('Error updating MQTT topic');
            $('#suggestion').text(typeof err === 'string' ? err : 'An unexpected error occurred');
            $('#modalError').modal('show');
          }
        });
      } else {
        // Add new topic
        api.device.mqtt.addTopic(deviceId, topicData, (err, res) => {
          if (!err) {
            loadMqttTopics();
            // Close the modal
            const modalElement = document.getElementById('editTopicModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            modal.hide();
          } else {
            console.log(err);
            $('#error').text('Error adding MQTT topic');
            $('#suggestion').text(typeof err === 'string' ? err : 'An unexpected error occurred');
            $('#modalError').modal('show');
          }
        });
      }
    }

  </script>

</body>
</html>