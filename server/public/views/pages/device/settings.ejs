<!DOCTYPE html>
<html lang="en">
<head>

  <%- include('../../partials/head.ejs') %>

</head>
<body>

  <%- include('../../partials/scripts.ejs') %>
  <%- include('../../partials/device/navbar.ejs') %>

  <%- include('../../partials/modal/confirmation.ejs') %>
  <%- include('../../partials/modal/error.ejs') %>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

  <div class="container-fluid">
      <div class="row flex-nowrap">
          <%- include('../../partials/device/sidebar.ejs') %>
          <div class="col py-3">
            <div class="row">
              <div class="col-sm-12 mb-4 mb-sm-0">
                <div class="content-header">
                  <h5>MQTT Available
                    <button id="mqtt_status" type="button" class="btn btn-secondary" disabled></button>
                  </h5>
                </div>
                <div class="col">
                <!--<div class="card">-->
                  <!--<h5 class="card-title">Special title treatment</h5>-->
                  <div class="mb-1 row">
                    <label for="project" class="col-sm-3 col-form-label">Project</label>
                    <div class="col-sm-7">
                      <input type="text" readonly class="form-control-plaintext fw-bold" id="project" value="ND">
                    </div>
                  </div>
                    <div class="mb-1 row">
                      <label for="model" class="col-sm-3 col-form-label">Model</label>
                      <div class="col-sm-7">
                        <input type="text" readonly class="form-control-plaintext fw-bold" id="model" value="ND">
                      </div>
                    </div>
                    <div class="mb-1 row">
                      <label for="fw_version" class="col-sm-3 col-form-label">FW version</label>
                      <div class="col-sm-7">
                        <input type="text" readonly class="form-control-plaintext fw-bold" id="fw_version" value="0.0.0">
                      </div>
                    </div>
                    <div class="mb-4 row">
                      <label for="app_version" class="col-sm-3 col-form-label">App version</label>
                      <div class="col-sm-7">
                        <input type="text" readonly class="form-control-plaintext fw-bold" id="app_version" value="0.0.0">
                      </div>
                    </div>
                    <!--
                    <div class="mb-4 row">
                      <label for="flexCheckDefault" class="col-sm-3 col-form-check">JavaScript</label>
                      <div class="col-sm-7">
                        <input class="form-check-input" type="checkbox" value="" id="flexCheckJS" disabled checked>
                      </div>
                    </div>
                    <div class="mb-5 row">
                      <label for="flexCheckDefault" class="col-sm-3 col-form-check">RS485</label>
                      <div class="col-sm-7">
                        <input class="form-check-input" type="checkbox" value="" id="flexCheckJS" disabled>
                      </div>
                    </div>
                    -->
                </div>
                <!--</div>-->
              </div>

              <div class="col-sm-12 mb-4 mb-sm-4">
                <div class="btn-group">
                  <label class="input-group-text" for="inputGroupSelect21">release</label>
                  <select class="form-select fwReleaseOption" id="_fwrelease_">
                  </select>
                </div>
                <!--
                <div class="card">
                  <div class="card-header">
                    <p>Firmware</p>
                  </div>
                  <div class="card-body">
                    <form class="row g-3 needs-validation" novalidate>
                      <div class="col-sm-6">

                      </div>
                    </form>
                  </div>
                </div>
                -->
              </div>

              <div class="col-sm-12 mb-4 mb-sm-4">
                <div class="card">
                  <div class="card-header">
                    <p>Settings</p>
                  </div>
                  <div class="card-body">
                    <form class="row g-3 needs-validation" novalidate>
                      <div class="col-sm-6">
                        <div class="btn-group">
                          <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            keepalive
                          </button>
                          <ul class="dropdown-menu">
                            <li>15s</li>
                            <li>30s</li>
                            <li>1min</li>
                            <li>15min</li>
                            <li>1h</li>
                            <li>6h</li>
                            <li>24h</li>
                          </ul>
                        </div>
                      </div>
                      <div class="col-sm-6">
                        <div class="btn-group">
                          <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            logs level
                          </button>
                          <ul class="dropdown-menu">
                            <li>Disabled</li>
                            <li>Error</li>
                            <li>Warn</li>
                            <li>Info</li>
                            <li>Debug</li>
                            <li>Verbose</li>
                          </ul>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="col-sm-12 mb-4 mb-sm-0">
                <div class="card">
                  <div class="card-header">
                    <p>Actions</p>
                  </div>
                  <div class="card-body">
                    <div class="mb-3 row">
                      <label for="reboot" class="col-sm-8 col-form-label">Reboot</label>
                      <div class="col-sm-4">
                        <button id="reboot" type="button" class="btn btn-primary btn-sm">set</button>
                      </div>
                    </div>
                    <div class="mb-3 row">
                      <label for="staticEmail" class="col-sm-8 col-form-label">Reset</label>
                      <div class="col-sm-4">
                        <button type="button" class="btn btn-warning btn-sm">set</button>
                      </div>
                    </div>

                  </div>
                </div>
              </div>

            </div>
          </div>
          <div class="col py-3">
            <div class ="row">
              <div class="col-sm-12 mb-4 mb-sm-4">
                <div class="content-header">
                  <h5>Device available
                    <button id="status" type="button" class="btn btn-secondary" disabled></button
                  </h5>
                </div>
                <div class="mb-1 row">
                  <label for="uptime" class="col-sm-3 col-form-label">Uptime</label>
                  <div class="col-sm-7">
                    <input type="text" readonly class="form-control-plaintext fw-bold" id="uptime" value="0">
                  </div>
                </div>
                <div class="mb-1 row">
                  <label for="tech" class="col-sm-3 col-form-label">Tech</label>
                  <div class="col-sm-7">
                    <input type="text" readonly class="form-control-plaintext fw-bold" id="tech" value="ND">
                  </div>
                </div>
                <div class="mb-5 row">
                  <label for="rssi" class="col-sm-3 col-form-label">RSSI</label>
                  <div class="col-sm-7">
                    <input type="text" readonly class="form-control-plaintext fw-bold" id="rssi" value="99">
                  </div>
                </div>
              </div>
              <div class="col-sm-12 mb-4 mb-sm-4">
                <div class="card">
                  <div class="card-header">
                    <p>WiFi</p>
                  </div>
                  <div class="card-body">
                    <form class="row g-3 needs-validation" validate>
                      <div class="col-md-6">
                        <label for="validationCustom01" class="form-label">SSID</label>
                        <input type="text" class="form-control" id="wifissid" value="" required>
                        <div class="valid-feedback">
                          Looks good!
                        </div>
                      </div>
                      <div class="col-md-6">
                        <label for="validationCustom02" class="form-label">Password</label>
                        <input type="text" class="form-control" id="wifipassword" value="" required>
                        <div class="valid-feedback">
                          Looks good!
                        </div>
                      </div>
                      <div class="col-md-4">
                        <button id="wifiset" class="btn btn-primary btn-sm" type="submit" onclick="return false;">set</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              <div class="col-sm-12 mb-4 mb-sm-4">
                <div class="card">
                  <div class="card-header">
                    <p>MQTT</p>
                  </div>
                  <div class="card-body">
                    <form class="row g-3 needs-validation" novalidate>
                      <div class="col-md-10">
                        <label for="validationMQTT01" class="form-label">Host</label>
                        <input type="text" class="form-control" id="mqtt_host" value="" required>
                        <div class="valid-feedback">
                          Looks good!
                        </div>
                      </div>
                      <div class="col-md-2">
                        <label for="validationMQTT02" class="form-label">Port</label>
                        <input type="number" class="form-control" id="mqtt_port" value="" required>
                        <div class="valid-feedback">
                          Looks good!
                        </div>
                      </div>
                      <div class="col-md-6">
                        <label for="validationMQTT03" class="form-label">User</label>
                        <input type="text" class="form-control" id="mqtt_user" value="" required>
                        <div class="valid-feedback">
                          Looks good!
                        </div>
                      </div>
                      <div class="col-md-6">
                        <label for="validationMQTT04" class="form-label">Password</label>
                        <input type="text" class="form-control" id="mqtt_pwd" value="" required>
                        <div class="valid-feedback">
                          Looks good!
                        </div>
                      </div>
                      <div class="col-md-4">
                        <button id="mqttset" class="btn btn-primary btn-sm" type="submit" onclick="return false;">set</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
      </div>
  </div>

  <!-- check link to more import options https://cdnjs.com/libraries/ace -->
  <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.14.0/ace.min.js" integrity="sha512-s57ywpCtz+4PU992Bg1rDtr6+1z38gO2mS92agz2nqQcuMQ6IvgLWoQ2SFpImvg1rbgqBKeSEq0d9bo9NtBY0w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.14.0/ace.js" integrity="sha512-WYlXqL7GPpZL2ImDErTX0RMKy5hR17vGW5yY04p9Z+YhYFJcUUFRT31N29euNB4sLNNf/s0XQXZfzg3uKSoOdA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>

    var deviceID = api.getDeviceID();
    var project = "";

    $(document).ready(()=>{

      api.getDeviceInfo(deviceID,(err,res)=>{
        if(err) console.log(err.responseJSON.Message)
        else if(res.length > 0){
          console.log(res)
          document.querySelector('#project').value = res[0].project;
          document.querySelector('#model').value = res[0].model;
          document.querySelector('#fw_version').value = res[0].fw_version;
          document.querySelector('#app_version').value = res[0].app_version;
          project = res[0].project;

          if(res[0].hasOwnProperty("fw_settings") && res[0].fw_settings != null){
            if(res[0].fw_settings.hasOwnProperty("wifi") && res[0].fw_settings.wifi != null){
              document.querySelector('#wifissid').value = res[0].fw_settings.wifi.ssid;
              document.querySelector('#wifipassword').value = res[0].fw_settings.wifi.pwd;
            }
            if(res[0].fw_settings.hasOwnProperty("mqtt") && res[0].fw_settings.mqtt != null){
              document.querySelector('#mqtt_host').value = res[0].fw_settings.mqtt.host;
              document.querySelector('#mqtt_port').value = res[0].fw_settings.mqtt.port;
              document.querySelector('#mqtt_user').value = res[0].fw_settings.mqtt.user;
              document.querySelector('#mqtt_pwd').value = res[0].fw_settings.mqtt.pass;
            }
          }

          addSelectedOption('#_fwrelease_',res[0].fw_release);
          addOption('#_fwrelease_',"stable");
          addOption('#_fwrelease_',"nightmare");

          $(".fwReleaseOption").change((event)=>{
            console.log("option changed")
            let id = event.target.id;
            $( ".fwReleaseOption option:selected" ).each(function() {
              let release = $( this ).text();
              api.updateDeviceRelease(deviceID,release,(err,res)=>{
                if(err){
                  $('#error').text("Your request cannot be executed");
                  if(err.hasOwnProperty("sqlMessage"))
                    $('#suggestion').text(err.sqlMessage);
                  else
                    $('#suggestion').text(err);
                  $('#modalError').modal('show');
                }
              });
            });
          });

          api.getMqttCredentials((err,res)=>{

            // connect the client
            if(res != null && res.length > 0){

              client = new Paho.MQTT.Client(Settings.mqtt.host, Settings.mqtt.port, res[0].idclients);

              // set callback handlers
              client.onConnectionLost = onConnectionLost;
              client.onMessageArrived = onMessageArrived;

              client.connect({
                userName:res[0].idusers,
                password:res[0].password,
                onSuccess:onConnect
              });
            }
          })

        }
      })
    });

    $("#reboot").click(()=>{
      console.log("reboot button clicked");
      sendMessage("fw/reboot/set","1");
    });

    $("#reset").click(()=>{
      console.log("reset button clicked");
      //sendMessage("fw/reset/set","1");
    });

    $("#wifiset").click(()=>{
      console.log("wifiset button clicked");
      let ssid = document.querySelector('#wifissid').value;
      let pwd = document.querySelector('#wifipassword').value;
      let data = {
        ssid : ssid,
        pwd : pwd
      }
      sendMessage("fw/wifi/set",JSON.stringify(data));
      // call waiting event
      // on received msg with publish null
      // stop waiting event
    });

    $("#mqttset").click((event)=>{
      console.log("mqttset button clicked");
      let host = document.querySelector('#mqtt_host').value;
      let port = document.querySelector('#mqtt_port').value;
      let user = document.querySelector('#mqtt_user').value;
      let pwd = document.querySelector('#mqtt_pwd').value;
      let data = {
        host : host,
        port : port,
        user : user,
        pass : pwd,
        active : 1
      }
      sendMessage("fw/mqtt/set",JSON.stringify(data));
      // call waiting event
      // on received msg with publish null
      // stop waiting event
    });

    // called when the client connects
    function onConnect() {
      // Once a connection has been made, make a subscription and send a message.
      let button = document.querySelector('#mqtt_status');
      button.classList.toggle("btn-secondary",false);
      button.classList.toggle("btn-success",true);
      client.subscribe(project+"/"+deviceID+"/#");
    }

    // called when the client loses its connection
    function onConnectionLost(responseObject) {
      button.classList.toggle("btn-secondary",false);
      button.classList.toggle("btn-danger",true);
      if (responseObject.errorCode !== 0) {
        console.log("onConnectionLost:"+responseObject.errorMessage);
      }
    }

    // called when a message arrives
    function onMessageArrived(message) {

      let topic = message.destinationName;
      let payload = message.payloadString;
      //console.log(topic);
      //console.log("payload:"+payload);
      if(topic.includes("status")){
        let button = document.querySelector('#status');
        button.classList.toggle("btn-secondary",false);
        if(payload == "online")
          button.classList.toggle("btn-success",true);
        else
          button.classList.toggle("btn-danger",true);
      }

      if(topic.includes("uptime")){
        let uptime = document.querySelector('#uptime');
        uptime.value = payload;
      }

      if(topic.includes("tech")){
        let tech = document.querySelector('#tech');
        tech.value = payload;
      }

      if(topic.includes("rssi")){
        let rssi = document.querySelector('#rssi');
        rssi.value = payload;
      }

    }

    function sendMessage(topic,payload){
      message = new Paho.MQTT.Message(payload);
      message.destinationName = project+"/"+deviceID+"/"+topic;
      client.send(message);
    }

    function addSelectedOption(id,release){

      $(id).append(`<option select value="${release}">
                                 ${release}
                            </option>`);
    }

    function addOption(id,release){

      $(id).append(`<option select value="${release}">
                                 ${release}
                            </option>`);
    }

    // On mqtt connect, topic subscribe, change status device
  </script>
</body>
</html>
