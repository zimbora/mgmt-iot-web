<!DOCTYPE html>
<html lang="en">
<head>

  <%- include('../../partials/head.ejs') %>

</head>
<body>

  <%- include('../../partials/scripts.ejs') %>
  <%- include('../../partials/device/navbar.ejs') %>

  <%- include('../../partials/modal/confirmation.ejs') %>
  <%- include('../../partials/modal/error.ejs') %>
  <%- include('../../partials/modal/success.ejs') %>
  <%- include('../../partials/modal/loading.ejs') %>
  <%- include('../../partials/modal/timeout.ejs') %>
  <%- include('../../partials/modal/logsChart.ejs') %>
  <%- include('../../partials/modal/logsList.ejs') %>

  <script src="./assets/js/jquery.min.js"></script>
  <link href="./assets/css/jquery.dataTables.min.css" rel="stylesheet"></link>
  <script src="./assets/js/jquery.dataTables.min.js"></script>
  <script src="./assets/js/mqttws31.min.js" type="text/javascript"></script>
  <script type="module" src="./app.mjs"></script>

  <div class="container-fluid">
    <div class="row flex-nowrap">
      <%- include('../../partials/device/sidebar.ejs') %>
      <div class="col">

        <div class="row py-3">
          <div class="col-12">
            <div class="content-header">
              <h5>LWM2M Resources</h5>
            </div>
            <div class="card overflow-auto" style="width:100%">
              <div class="card-body">
                <table id="lwm2mResources" class="display" style="width:100%">
                  <caption><b>Device Resources</b></caption>
                  <thead>
                    <tr>
                      <th>Object ID</th>
                      <th>Object Instance ID</th>
                      <th>Resource ID</th>
                      <th>Observing</th>
                      <th>Template Tag</th>
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    let deviceId;
    let t;

    $(document).ready(() => {
      deviceId = api.getDeviceID();
      
      // Initialize DataTable
      t = $('#lwm2mResources').DataTable({
        "pageLength": 25,
        "order": [[0, "asc"]]
      });

      // Load LWM2M resources
      loadLwm2mResources();
    });

    function loadLwm2mResources() {
      api.device.getLwm2mResources(deviceId, null, (err, resources) => {
        if (err) {
          console.log('Error loading LWM2M resources:', err);
        } else {
          // Clear existing data
          t.clear();
          
          if (resources && resources.length > 0) {
            resources.forEach((resource, i) => {
              addResourceRow(resource);
            });
          }
          
          t.draw();
        }
      });
    }

    function addResourceRow(resource) {
      const observingStatus = resource.observing ? 
        '<span class="badge bg-success">Yes</span>' : 
        '<span class="badge bg-secondary">No</span>';
      
      const templateTag = resource.tag ? 
        `<span class="badge bg-success">${resource.tag}</span>` : 
        '<span class="badge bg-light text-muted">None</span>';

      t.row.add([
        resource.objectId,
        resource.objectInstanceId,
        resource.resourceId,
        observingStatus,
        templateTag
      ]);
    }
  </script>

</body>
</html>